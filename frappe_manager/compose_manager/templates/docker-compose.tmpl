version: "3.9"
services:
  frappe:
    # image: ghcr.io/rtcamp/frappe-manager-frappe:v0.10.0
    image: frappe-manager-frappe:v0.10.0
    environment:
      ADMIN_PASS: REPLACE_ME_WITH_FRAPPE_WEB_ADMIN_PASS
      # apps are defined as <app-name>:<branch-name>, if branch name not given then default github branch will be used.
      APPS_LIST: REPLACE_ME_APPS_LIST
      DB_NAME: REPLACE_ME_WITH_DB_NAME_TO_CREATE
      # DEVERLOPER_MODE bool -> true/false
      DEVELOPER_MODE: REPLACE_ME_WITH_DEVELOPER_MODE_TOGGLE
      FRAPPE_BRANCH: REPLACE_ME_WITH_BRANCH_OF_FRAPPE
      SITENAME: REPLACE_ME_WITH_THE_SITE_NAME
      USERGROUP: REPLACE_ME_WITH_CURRENT_USER_GROUP
      USERID: REPLACE_ME_WITH_CURRENT_USER
      MARIADB_ROOT_PASS: REPLACE_ME_WITH_MARIADB_ROOT_PASS
    volumes:
      - ./workspace:/workspace:cached
    expose:
      - 80
    labels:
        devcontainer.metadata: '[{ "remoteUser": "frappe"}]'
    networks:
      site-network:

  nginx:
    # image: ghcr.io/rtcamp/frappe-manager-nginx:v0.10.0
    image: frappe-manager-nginx:v0.10.0
    user: REPLACE_ME_WITH_CURRENT_USER:REPLACE_ME_WITH_CURRENT_USER_GROUP
    environment:
      # not implemented as of now
      ENABLE_SSL: REPLACE_ME_WITH_TOGGLE_ENABLE_SSL
      SITENAME: REPLACE_ME_WITH_THE_SITE_NAME
      # for nginx-proxy
      VIRTUAL_HOST: REPLACE_ME_WITH_SITE_NAME
      VIRTUAL_PORT: 80
    volumes:
      - ./workspace:/workspace:cached
      - ./configs/nginx/conf:/etc/nginx
      - ./configs/nginx/logs:/var/log/nginx
      - ./configs/nginx/cache:/var/cache/nginx
      - ./configs/nginx/run:/var/run
    ports:
      - 80:80
    networks:
      site-network:

  mariadb:
    image: mariadb:10.6
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
      - --skip-innodb-read-only-compressed # Temporary fix for MariaDB 10.6
    environment:
      MYSQL_ROOT_PASSWORD: root
    volumes:
      - mariadb-data:/var/lib/mysql
    networks:
      site-network:

  mailhog:
    image: ghcr.io/rtcamp/frappe-manager-mailhog:v0.8.3
    expose:
      - 1025
      - 8025
    networks:
      site-network:

  adminer:
    image: adminer:latest
    environment:
      - ADMINER_DEFAULT_SERVER=mariadb
    expose:
      - 8080
    networks:
      site-network:

  socketio:
    image: frappe-manager-frappe:v0.10.0
    environment:
      TIMEOUT: 60000
      CHANGE_DIR: /workspace/frappe-bench/logs
      WAIT_FOR: '/workspace/frappe-bench/config/frappe-bench-node-socketio.fm.supervisor.conf'
      COMMAND: |
        ln -sfn /workspace/frappe-bench/config/frappe-bench-node-socketio.fm.supervisor.conf /opt/user/conf.d/frappe-bench-node-socketio.fm.supervisor.conf
        supervisord -c /opt/user/supervisord.conf
    expose:
      - 80
    command: launch.sh
    volumes:
      - ./workspace:/workspace:cached
    networks:
      site-network:

  schedule:
    image: frappe-manager-frappe:v0.10.0
    environment:
      TIMEOUT: 60000
      CHANGE_DIR: /workspace/frappe-bench
      WAIT_FOR: '/workspace/frappe-bench/config/frappe-bench-frappe-schedule.fm.supervisor.conf'
      COMMAND: |
        ln -sfn /workspace/frappe-bench/config/frappe-bench-frappe-schedule.fm.supervisor.conf /opt/user/conf.d/frappe-bench-frappe-schedule.fm.supervisor.conf
        supervisord -c /opt/user/supervisord.conf
    command: launch.sh
    volumes:
      - ./workspace:/workspace:cached
    networks:
      site-network:

  redis-cache:
    image: redis:alpine
    volumes:
      - redis-cache-data:/data
    expose:
      - 6379
    networks:
      site-network:

  redis-queue:
    image: redis:alpine
    volumes:
      - redis-queue-data:/data
    expose:
      - 6379
    networks:
      site-network:

  redis-socketio:
    image: redis:alpine
    volumes:
       - redis-socketio-data:/data
    expose:
      - 6379
    networks:
      site-network:

volumes:
  mariadb-data:
  redis-socketio-data:
  redis-queue-data:
  redis-cache-data:

networks:
  site-network:
    name: REPLACE_ME_WITH_SITE_NAME_NETWORK
